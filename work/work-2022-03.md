## 03-03

### 小程序场景值

onLaunch 和 onShow，或wx.getLaunchOptionsSync 中获取上述场景值

```js

  onLaunch(options) {
    console.log('App onLaunch Scene:', options.scene);//options.scene 是 String 类型的 
  },
  onShow(options) {
    console.log('App onShow Scene:', options.scene);
  },
```

### 小程序头像剪切模块

https://ext.dcloud.net.cn/plugin?id=233  
https://ext.dcloud.net.cn/plugin?id=5784  


## 03-08

### 超时捕获类

```js
export class TimeoutTest {
  constructor(title = "") {
    this.title = title || redomStr();
    this.map = {};
  }
  add(data, timeout = 20 * 1000) {
    let timestamp = new Date().getTime();
    let itemkey = `${timestamp}_${redomStr()}`;
    let timer = setTimeout(() => {
      console.error(this.map[itemkey]);
      delete this.map[itemkey];
    }, timeout);
    let item = {
      title: this.title,
      timestamp,
      timestampStr: dayjs(timestamp).format("YYYY-MM-DD HH:mm:ss SSS"),
      timeout: timeout,
      data,
      timer,
      itemkey,
    };
    this.map[itemkey] = item;
    return itemkey;
  }
  del(key) {
    if (this.map[key]) {
      clearTimeout(this.map[key].timer);
      delete this.map[key];
    }
  }
}

import { http } from "@/utils/http.js";

let htmlTt = new TimeoutTest();
async function ttHtml(...args) {
  let ttkey = htmlTt.add(args);
  let res = await http(...args);
  htmlTt.del(ttkey);
  return res;
}

```

### watch 和 声明
小程序在const 声明之前watch 会无法触发


## 03-09

### aroc tooltips 元素滚动bug
aroc的 hover只抓取了页面的滚动， element 的hover 可以抓到内部的滚动

### 小程序下拉和定位bug
ios 小程序无法禁止页面下拉，下拉过程fixed定位元素不会一起向下移动,都是调用wx.stopPullDownRefresh() 时会被顶下来  
使用页面滚动事件 根据滚动位置小于0时使用absolute定位，大于0时使用fixed定位

安卓端可以禁止页面下拉，下拉式fixed元素会一起向下移动

### 小程序权限逻辑

```vue
<template>
  <view class="component-write-photos-album">
    <ytt-dialog
      v-model:visible="pageJumpVisible"
      title="授权"
      info="请开启添加相册权限"
      confirmText="去开启"
      cancelText="稍候再说"
      :zIndex="1050"
      @confirm="jumpConfirm"
      @cancel="jumpCancel"
      @modalClick="jumpModalClick"
    />
  </view>
</template>

<script>
/* message */
import { ref } from "vue";

export default {
  name: "WritePhotosAlbum",
  setup(props, context) { // eslint-disable-line
    const { attrs, slots, emit } = context; // eslint-disable-line

    async function getAlbum() {
      try {
        // 拿系统设置 检查权限
        let sres = await uni.getSetting({});
        if (!/:ok$/.test(sres.errMsg)) {
          console.error(sres);
          return false;
        }
        if (!sres.authSetting["scope.writePhotosAlbum"]) {
          try {
            // 尝试弹窗获取添加相册权限
            let ares = await uni.authorize({
              scope: "scope.writePhotosAlbum",
            });
            if (!/:ok$/.test(ares.errMsg)) {
              console.error(ares);
              return false;
            }
          } catch (e) {
            console.error(e);
            return await pageAlbum();
          }
        }
      } catch (error) {
        console.error(error);
      }
      return true;
    }
    const pageJumpVisible = ref(false);
    // 弹窗动作触发回调
    let pResolve = null;
    // 弹窗动作触发回调
    let pReject = null; // eslint-disable-line 
    async function pageAlbum() {
      // 打开弹窗询问并跳转授权页面
      pageJumpVisible.value = true; // 打开弹窗
      return new Promise((resolve, reject) => {
        pResolve = async (jump) => {
          pResolve = null; // 进来一定先清空自己
          pReject = null; // 进来一定先清空自己

          let album = false; // 有权限/无权限
          if (jump) {
            // 弹窗点击跳转授权
            try {
              const ores = await wx.openSetting();
              console.log("ores", ores);

              //授权调用失败
              if (!ores || !/:ok$/.test(ores.errMsg)) {
                console.error(ores);
                album = false;
              } else {
                album = ores.authSetting["scope.writePhotosAlbum"];
              }
            } catch (e) {
              console.error(e);
              album = false;
            }
          } else {
            // 弹窗点击取消授权
            album = false;
          }
          resolve(album);
        };
        pReject = () => {
          pResolve = null; // 进来一定先清空自己
          pReject = null; // 进来一定先清空自己
          reject();
        };
      });
    }
    function jumpConfirm() {
      pResolve && pResolve(true);
    }
    function jumpCancel() {
      // pReject && pReject();
      pResolve && pResolve(false);
    }
    function jumpModalClick() {
      // pReject && pReject();
      pResolve && pResolve(false);
    }
    return {
      pageJumpVisible,
      getAlbum,
      jumpConfirm,
      jumpCancel,
      jumpModalClick,
    };
  },
};
</script>

<style lang="scss" scoped>
.component-write-photos-album {
  //
}
</style>
```

```js

    <writePhotosAlbum ref="getAlbumRef"></writePhotosAlbum>

    const getAlbumRef = ref(null);
    async function downClick() {
      if (downloading) {
        return;
      }
      try {
        if (!getAlbumRef.value) {
          uni.showToast({
            title: "代码出错",
            icon: "none",
            duration: 2000,
          });
          console.log("getAlbumRef.value", getAlbumRef.value);
          return;
        }
        let res = await getAlbumRef.value.getAlbum();
        if (!res) {
          uni.showToast({
            title: "没有访问相册权限",
            icon: "none",
          });
          return;
        }
        downloading = true;
        await downloadSaveFileList(selUrlList.value);
      } catch (error) {
        console.error(error);
      }
      downloading = false;
    }
```
